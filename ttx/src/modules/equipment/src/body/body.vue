<template>
  <div class="relative w-11/12 m-auto bg-white">
    <n-modal v-model:show="showModal" class="w-2/3 bg-white h-1/2" :mask-closable="false">
      <div>
        <!-- <n-form
          class="relative font-sans"
          :bordered="false"
          size="medium"
          label-placement="left"
          label-width="110"
          :rules="rules"
        >
          <div class="mt-4 ml-5 text-lg">ÁºñËæëËÆæÂ§á</div>
          <n-divider class="bg-gary-500" />
          <n-form-item label="">
           <n-grid :cols="24" :x-gap="2" collapsed-rows:5>
            <n-form-item-gi
              :span="12"
              path="type"
              label="Á±ªÂûãÈÄâÊã©"
              class="mt-5 ml-20 w-80"
            >
              <n-select
                clearable
                showRequireMark:true
                :options="typeOptions"
                v-model:value="changeInfo.type"
              />
            </n-form-item-gi>
            <n-form-item-gi :span="12" label="ËÆæÂ§áÁºñÂè∑" class="mt-5 w-80">
              <n-input disabled v-model:value="changeInfo.itemNo" clearable />
            </n-form-item-gi>
            <n-form-item-gi
              :span="12"
              path="subName"
              label="ËÆæÂ§áÂêçÁß∞"
              class="mt-5 ml-20 w-80"
            >
              <n-input v-model:value="changeInfo.subName" clearable />
            </n-form-item-gi>
            <n-form-item-gi
              :span="12"
              path="host"
              label="ÈÄöËÆØÂú∞ÂùÄ"
              class="mt-5 w-80"
            >
              <n-input v-model:value="changeInfo.host" clearable />
            </n-form-item-gi>
            <n-form-item-gi
              :span="12"
              path="port"
              label="Á´ØÂè£Âè∑"
              class="mt-5 ml-20 w-80"
            >
              <n-input v-model:value="changeInfo.port" clearable />
            </n-form-item-gi>
            <n-form-item-gi
              :span="12"
              path="freq"
              label="ÈááÈõÜÊ≠•Èïø"
              class="mt-5 w-80"
            >
              <n-input v-model:value="changeInfo.freq" clearable />
            </n-form-item-gi>
            <n-form-item-gi :span="12" label="Áà∂Á∫ßËÆæÂ§á" class="mt-5 ml-20 w-80">
              <n-select
                :options="parentNameOptions"
                v-model:value="changeInfo.parentId"
                clearable
              />
            </n-form-item-gi>
            <n-form-item-gi
              :span="12"
              path="protocol"
              label="ÂçèËÆÆÁ±ªÂûã"
              class="mt-5 w-80"
            >
              <n-select
                :options="dictItemProtocolOptions"
                v-model:value="changeInfo.protocol"
                clearable
              />
            </n-form-item-gi>
            <n-form-item-gi
              :span="12"
              path="model"
              label="ËÆæÂ§áÂûãÂè∑"
              class="mt-5 ml-20 w-80"
            >
              <n-select
                :options="dictItemModelOptions"
                v-model:value="changeInfo.model"
                clearable
              />
            </n-form-item-gi>
            <n-form-item-gi
              :span="12"
              path="brand"
              label="ËÆæÂ§áÂéÇÂïÜ"
              class="mt-5 w-80"
            >
              <n-select
                :options="dictItemBrandOptions"
                v-model:value="changeInfo.brand"
                clearable
              />
            </n-form-item-gi>
            <n-form-item-gi :span="12" label="ÂàõÂª∫Êó∂Èó¥" class="mt-5 ml-20 w-80">
              <n-date-picker
                v-model:formatted-value="changeInfo.createTime"
                value-format="yyyy-MM-dd HH:mm:ss"
                type="datetime"
                size="large"
                clearable
              />
            </n-form-item-gi>
            <n-form-item-gi
              :span="12"
              label="ËÆæÂ§áÊâÄÂ±ûÂú∫Á´ô"
              path="baseName"
              class="mt-5 w-80"
              clearable
            >
              <n-select
                :options="baseNameOptions"
                v-model:value="changeInfo.orgId"
                clearable
              />
            </n-form-item-gi>
            <n-form-item-gi
              :span="12"
              path="slave"
              label="‰ªéÁ´ôÂè∑"
              class="mt-5 ml-20 w-80"
            >
              <n-input v-model:value="changeInfo.slave" clearable />
            </n-form-item-gi>
          </n-grid>
        </n-form-item>

          <div class="absolute bottom-0 mt-2 space-x-3 font-sans mb-7 right-10">
            <n-button
              type="primary"
              ghost
              text-color="black"
              @click="equipment.showModal = false"
            >
              ÂèñÊ∂à
            </n-button>
            <n-button
              v-if="isadd"
              type="info"
              class="bg-blue-400"
              @click="handleTest"
            >
              ÈìæÊé•ÊµãËØï
            </n-button>
            <n-button type="info" class="bg-blue-400" @click="handle">
              ‰øùÂ≠ò
            </n-button>
          </div>
          <n-divider class="mb-10 bg-gary-500" />
        </n-form> -->
      <!-- <Iform :isadd="isadd" :id="id" /> -->
      <!-- <useForm /> -->
      <BasicForm
          @register="register"
          @submit="handleSubmit"
          @reset="handleReset"
        >
        </BasicForm>
      </div>
    </n-modal>
    <n-space class="relative bg-white">
      <n-space inline class="mt-2 space-x-2 font-sans">
        <div class="mt-2 ml-7">ËÆæÂ§áÁÆ°ÁêÜ</div>
        <div class="absolute right-0">
          <n-space>
            <n-button class="bg-blue-400" @click="add" type="info"
              >Êñ∞Â¢ûËÆæÂ§á</n-button>
            <n-button
              @click="handleConfirm"
              class="mr-5 bg-red-400"
              type="error"
              >Âà†Èô§ËÆæÂ§á</n-button>
          </n-space>
        </div>
      </n-space>
      <n-data-table
        remote
        :loading="loading"
        :columns="columns"
        :data="data"
        :bordered="false"
        :single-line="false"
        :max-height="423"
        :min-height="423"
        :row-key="rowKey"
        @update:checked-row-keys="handleCheck"
        class="mt-2 mb-6"
      />
      <pagination />
    </n-space>
  </div>
</template>
<script setup lang="ts">
import { NButton } from "naive-ui";
import { equipmentStore } from "../store/equipment";
import { storeToRefs } from "pinia";
// @ts-ignore
import { onMountedOrActivated } from "/@/hooks/core/onMountedOrActivated";
import pagination from "./pagination/pagination.vue";
import Iform from "./form/Iform.vue";
import type { DataTableRowKey } from "naive-ui";
// @ts-ignore
import { dialog, message } from "/@/components/Dialog";
// import  useForm  from "../../../../views/useForm.vue";
// @ts-ignore
import { BasicForm, FormSchema, useForm } from "/@/components/Form/index";
const equipment = equipmentStore();
let {
  data,
  loading,
  showModal,
  changeInfo,
  rules,
  parentNameOptions,
  dictItemProtocolOptions,
  baseNameOptions,
  dictItemModelOptions,
  dictItemBrandOptions,
} = storeToRefs(equipment);
let typeOptions = reactive([
  {
    label: "tcu",
    value: "7",
  },
  {
    label: "ncu",
    value: "6",
  },
]);
let isadd = false;
let id = null;
const columns = [
  {
    type: "selection",
    // key:"id"
  },
  {
    title: "ËÆæÂ§áÂêçÁß∞",
    key: "subName",
    ellipsis: {
      tooltip: true,
    },
  },
  {
    title: "ËÆæÂ§áÁºñÂè∑",
    key: "itemNo",
    ellipsis: {
      tooltip: true,
    },
  },
  {
    title: "ÊâÄÂ±ûÂú∫Á´ô",
    key: "baseName",
    ellipsis: {
      tooltip: true,
    },
  },
  {
    title: "ËÆæÂ§áÁ±ªÂûã",
    key: "type",
    ellipsis: {
      tooltip: true,
    },
  },
  {
    title: "Áà∂Á∫ßËÆæÂ§á",
    key: "parentName",
    ellipsis: {
      tooltip: true,
    },
  },
  {
    title: "Êìç‰Ωú",
    key: "actions",
    ellipsis: {
      tooltip: true,
    },
    render(row: any) {
      return h(
        NButton,
        {
          text: true,
          type: "info",
          textColor: "rgba(9,83,203,0.7)",
          size: "small",
          onClick: () => Edit(row),
        },
        { default: () => "ÁºñËæëËÆæÂ§á" }
      );
    },
  },
];
const schemas: FormSchema[] = [
  {
    field: "name",
    component: "NInput",
    label: "ÂßìÂêç",
    labelMessage: "ÁÉ≠ÁÉàÁöÑüêé",
    giProps: {
      span: 1,
    },
    componentProps: {

      placeholder: "ËØ∑ËæìÂÖ•ÂßìÂêç",
      onInput: (e: any) => {
        console.log(e);
      },
    },
    rules: [{ required: true, message: "ËØ∑ËæìÂÖ•ÂßìÂêç", trigger: ["blur"] }],
  },
  {
    field: "mobile",
    component: "NInputNumber",
    label: "ÊâãÊú∫",
    componentProps: {
      placeholder: "ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑Á†Å",
      showButton: false,
      onInput: (e: any) => {
        console.log(e);
      },
    },
  },
  {
    field: "type",
    component: "NSelect",
    label: "Á±ªÂûã",
    giProps: {
      //span: 24,
    },
    componentProps: {
      placeholder: "ËØ∑ÈÄâÊã©Á±ªÂûã",
      options: [
        {
          label: "ËàíÈÄÇÊÄß",
          value: 1,
        },
        {
          label: "ÁªèÊµéÊÄß",
          value: 2,
        },
      ],
      onUpdateValue: (e: any) => {
        console.log(e);
      },
    },
  },
  {
    field: "makeDate",
    component: "NDatePicker",
    label: "È¢ÑÁ∫¶Êó∂Èó¥",
    giProps: {
      //span: 24,
    },
    defaultValue: 1183135260000,
    componentProps: {
      type: "date",
      clearable: true,
      onUpdateValue: (e: any) => {
        console.log(e);
      },
    },
  },
  {
    field: "makeTime",
    component: "NTimePicker",
    label: "ÂÅúÁïôÊó∂Èó¥",
    giProps: {
      //span: 24,
    },
    componentProps: {
      clearable: true,
      onUpdateValue: (e: any) => {
        console.log(e);
      },
    },
  },
  {
    field: "makeProject",
    component: "NCheckbox",
    label: "È¢ÑÁ∫¶È°πÁõÆ",
    giProps: {
      //span: 24,
    },
    componentProps: {
      placeholder: "ËØ∑ÈÄâÊã©È¢ÑÁ∫¶È°πÁõÆ",
      options: [
        {
          label: "ÁßçÁâô",
          value: 1,
        },
        {
          label: "Ë°•Áâô",
          value: 2,
        },
        {
          label: "Ê†πÁÆ°",
          value: 3,
        },
      ],
      onUpdateChecked: (e: any) => {
        console.log(e);
      },
    },
  },
  {
    field: "makeSource",
    component: "NRadioGroup",
    label: "Êù•Ê∫ê",
    giProps: {
      //span: 24,
    },
    componentProps: {
      options: [
        {
          label: "ÁΩë‰∏ä",
          value: 1,
        },
        {
          label: "Èó®Â∫ó",
          value: 2,
        },
      ],
      onUpdateChecked: (e: any) => {
        console.log(e);
      },
    },
  },
];
const [register, {}] = useForm({
  gridProps: { cols: 2 },
  collapsedRows: 3,
  labelWidth: 120,
  layout: "horizontal",
  submitButtonText: "Êèê‰∫§È¢ÑÁ∫¶",
  // submitButtonOptions: { ghost:true },
  schemas,
});

function handleSubmit(values: Recordable) {
  console.log(values);
  message.success(JSON.stringify(values));
}

function handleReset(values: Recordable) {
  console.log(values);
}
function rowKey(row: any) {
  // console.log(row)
  return row.id;
}
function handleCheck(rowKeys: DataTableRowKey[]) {
  equipment.checkedRowKeysRef = rowKeys.join(",");
}
async function Edit(rowData: any) {
  isadd = false;
  equipment.showModal = true;
  id = rowData.id
  // equipment.editItem(rowData.id);
}
function add() {
  isadd = true;
  equipment.showModal = true;
  equipment.add();
}
async function handle() {
  if (isadd == true) {
    let res = await equipment.addItem();
    if (res == true) {
      equipment.showModal = false;
      equipment.getData(1, equipment.pageSize);
    }
  } else {
    let res = await equipment.updateItem();
    if (res == true) {
      equipment.showModal = false;
      equipment.getData(equipment.page, equipment.pageSize);
    }
  }
}
async function handleTest() {
  await equipment.test();
}
function handleConfirm() {
  dialog.warning({
    title: "Ë≠¶Âëä",
    content: "Âà†Èô§Êï∞ÊçÆÂèØËÉΩ‰ºöÂºïËµ∑Êï∞ÊçÆÂ¥©Ê∫ÉÔºåÊòØÂê¶Á°ÆÂÆöÂà†Èô§Ôºü",
    maskClosable: false,
    positiveText: "Á°ÆÂÆö",
    closable: false,
    // showIcon:false,
    positiveButtonProps: {
      type: "error",
      // round: true,
      ghost: true,
    },
    negativeText: "ÂèñÊ∂à",
    negativeButtonProps: {
      type: "success",
      round: true,
      ghost: true,
    },
    onPositiveClick: () => {
      del();
    },
    onNegativeClick: () => {
      message.warning("ÂèñÊ∂àÂà†Èô§");
    },
  });
}
async function del() {
  let res = await equipment.delData();
  if (res === true) {
    message.success("Âà†Èô§ÊàêÂäü");
  } else if (res === "message.exceptions.exception_17") {
    message.error("ËÆæÂ§áÂ≠òÂú®Â≠êËÆæÂ§áÔºåÊó†Ê≥ïÂà†Èô§");
  } else if (res === "message.exceptions.exception_69") {
    message.error("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑËÆæÂ§á");
  } else {
    message.error("Âà´ÁöÑÈîôËØØÊçè");
  }
}
onMountedOrActivated(async () => {
  await equipment.getData(1, equipment.pageSize);
});
</script>
<style scoped></style>
